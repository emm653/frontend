<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Verification & Minting</title>
 

 
</head>
<body>
  <h1>Welcome to the GitHub Verification and Minting Site</h1>

  <!-- GitHub Login Button -->
  <button id="github-login">Login with GitHub</button>
  <p id="status-message"></p>

  <button id="githubLogoutBtn" style="display: none;">Disconnect GitHub</button>


  <!-- MetaMask Connection Button -->
  <button id="metamask-login">Connect MetaMask</button>
  <p id="wallet-address">Not connected</p>
  <button id="disconnect-btn" style="display:none;">Disconnect MetaMask</button>

  
  <div id="text"></div>
  
  <!-- Minting Button (hidden initially) -->
  <button id="mint-button" style="display:none;">Mint NFT</button>
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

  <script>
    // MetaMask Connection
    let web3;
    let userAccount;

    // MetaMask Connection
    document.getElementById("metamask-login").onclick = async function() {
      if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
          // Request account access
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0]; // Store the connected account
          alert("MetaMask Connected: " + userAccount);
          const shortAddress = userAccount.slice(0, 6) + "..." + userAccount.slice(-4); // Shortened address
          document.getElementById("wallet-address").textContent = `Connected: ${shortAddress}`;
          document.getElementById("disconnect-btn").style.display = "inline-block"; // Show disconnect button
        } catch (error) {
          alert("Please connect MetaMask");
        }
      } else {
        alert("Please install MetaMask");
      }
    };

    document.getElementById("disconnect-btn").onclick = function() {
      userAccount = null; // Clear the account state
      document.getElementById("wallet-address").textContent = "Not connected"; // Reset the address
      document.getElementById("disconnect-btn").style.display = "none"; // Hide the disconnect button
    };

    // GitHub OAuth Login
    document.getElementById("github-login").onclick = function() {
      window.location.href = "https://soulbound-nft-project.onrender.com/auth/github";
    };

    // Handle redirection from backend (GitHub verification)
    document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const status = urlParams.get("status");
  const githubUsername = urlParams.get("github");

  if (status) {
    const decodedStatus = decodeURIComponent(status.replace(/\+/g, ' '));
    alert(`GitHub Login Result: ${decodedStatus}`);

    if (decodedStatus === "Account Verified") {
      document.getElementById("mint-button").style.display = "inline-block";
      document.getElementById("status-message").textContent =  ` ✅ Github account "${githubUsername}" is verfied!`;
    } else {
      document.getElementById("status-message").textContent = `❌ GitHub account "${githubUsername}" is too new. Cannot mint.`;
    }
  }
});


    document.getElementById("mint-button").onclick = async function() {
      if (!userAccount) {
        alert("Please connect your MetaMask wallet first!");
        return;
      }

      const tokenURI = "ipfs://bafkreifkisuugyll6jenaz5hp6ewdunnawjhyhhnjnhdiraakxoaq6tuou";
      const contractAddress = "0x71251C2f0ee20509a980289B69F25ff038bed2B9";
      const contractABI = [
        {
          "inputs": [{ "internalType": "string", "name": "tokenURI", "type": "string" }],
          "name": "mintBadge",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [{ "internalType": "address", "name": "user", "type": "address" }],
          "name": "verifyUser",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        }
      ];

      try {
        const web3 = new Web3(window.ethereum);
        const contract = new web3.eth.Contract(contractABI, contractAddress);

        // Step 1: Verify the user first
        await contract.methods.verifyUser(userAccount).send({ from: userAccount });
        console.log(" ✅User verified");

        // Step 2: Mint the NFT
        await contract.methods.mintBadge(tokenURI).send({ from: userAccount });
        alert("✅ NFT Minted Successfully!");
        document.getElementById("mint-button").style.display = "none";
      } catch (error) {
        console.error("Transaction failed", error);
        alert("❌ Transaction failed: " + (error?.message || "Unknown error"));
      }
    };
    // After successful mint
    

  </script>
  

  <script src="index.js"></script>
</body>
</html>
